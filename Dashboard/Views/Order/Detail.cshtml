@model QuestionsSYS.Models.Order

@{
    ViewBag.Title = "Sipariş Detay";
}

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Yeni Sipariş</h2>
        <ol class="breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Dashboards")">Yönetim</a>
            </li>
            <li>
                <a href="@Url.Action("Index", "Order")">Siparişlerim</a>
            </li>
            <li class="active">
                <strong>Yeni Sipariş</strong>
            </li>
        </ol>
    </div>

</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="ibox-content">

            <form role="form" action="/Order/Update/@Model.id" method="post">
                <div class="form-group">
                    <h2>
                        Sipariş Bilgileri
                        @if (Model.state == "Onay Bekliyor")
                        {
                            <span style="float:right" class="label label-warning">Onay Bekleniyor</span>
                        }
                        @if (Model.state == "Onaylandı")
                        {
                            <span style="float:right" class="label label-primary">Onaylandı</span>
                        }
                        @if (Model.state == "Red Edildi")
                        {
                            <span style="float:right" class="label label-danger">Red</span>
                        }
                    </h2>
                    <label for="customer_id">Müşteri</label>
                    <select required name="customer_id" id="customer_id" class="customer_id inline form-control">
                        <option></option>
                        @foreach (var item in ViewBag.customers)
                        {

                            <option @(item.id == Model.customer_id ? "selected" : String.Empty) value="@item.id">@item.name @item.lastname (@item.city - @item.town)</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label for="name">Ad</label>
                    <input autocomplete="off" type="text" placeholder="Ad" name="name" id="name" value="@Model.name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="lastname">Ad</label>
                    <input autocomplete="off" type="text" placeholder="Soyad" name="last_name" id="last_name" value="@Model.last_name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="address">Adres</label>
                    <textarea autocomplete="off" required type="text" cols="3" rows="3" placeholder="Adres" name="address" id="address" class="form-control">@Model.address</textarea>
                </div>
                <div class="form-group">
                    <select required name="city" id="city" class="city inline form-control">
                        <option></option>
                        @foreach (var item in ViewBag.cities)
                        {
                            <option @(item.id == Model.city ? "selected" : String.Empty) value="@item.id">@item.city_name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <select required name="town" id="town" class="town inline form-control">
                        <option></option>
                        @foreach (var item in ViewBag.towns)
                        {
                            <option @(item.id == Model.town ? "selected" : String.Empty) value="@item.id">@item.town_name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label for="phone">Tel</label>
                    <input autocomplete="off" type="number" value="@Model.phone" required type="text" placeholder="Tel" name="phone" id="phone" class="form-control">
                </div>




                <button class="btn  btn-primary no-margins" type="submit">Tamam</button>
            </form>
        </div>
    </div>
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="ibox-content">
                <h2>Ürün Bilgileri</h2>
                <form role="form" action="/Order/ProductsAdd/@Model.id" method="post">
                    <div class="table-responsive">
                        <table class="table table-responsive">
                            <thead>
                                <tr>
                                    <th>Ürün</th>
                                    <th>Miktar</th>
                                    <th>Fiyat</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    <td>
                                        <div class="form-group">
                                            <select required name="product_name" id="products" class="products inline form-control">
                                                <option></option>
                                                @foreach (var item in ViewBag.products)
                                                {
                                                    <option value="@item.product_name">@item.product_name</option>
                                                }
                                            </select>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group">
                                            <input autocomplete="off" type="number" value="1" required type="text" placeholder="Miktar" name="qty" id="qty" class="form-control">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="form-group">
                                            <input autocomplete="off" type="text" value="" data-val-regex-pattern="([a-zA-Z0-9 .&amp;&#39;-]+)" required type="text" placeholder="Fiyat" name="price" id="price" class="form-control">
                                        </div>
                                    </td>
                                    <td><button class="btn  btn-primary no-margins" type="submit">Ekle</button></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </form>
            </div>
        </div>
    </div>
    </div>

    @section Styles{
        @Styles.Render("~/plugins/toastrStyles")
        @Styles.Render("~/plugins/select2Styles")
    }
    @section Scripts{
        @Scripts.Render("~/plugins/toastr")
        @Scripts.Render("~/plugins/select2")

        <script type="text/javascript">

            function AddSuccess() {
                toastr.success("Ürün eklendi.", "Tamam");
            }
            function AddFailed() {
                toastr.error("Numara kullanılıyor veya bir hata oluştu tekrar deneyin.", "Hata")
            }

            function OnAdding() {
                $('.ibox-content').toggleClass('sk-loading');
            }

            function OnAddComplate() {
                $('.ibox-content').toggleClass('sk-loading');
            }

            if (location.search.indexOf("success=failed") > -1) {
                toastr.error("Lütfen tüm bilgileri eksiksiz doldurun.", "Hata")
            }
            if (location.search.indexOf("success=ok") > -1) {
                toastr.success("Kayıt güncellendi.", "Tamam")
            }

            $(".customer_id").select2({
                placeholder: "Müşteri seçin",
                allowClear: true
            });


            $(".city").select2({
                placeholder: "Şehir",
                allowClear: true
            });
            $(".products").select2({
                placeholder: "Ürünler",
                allowClear: true
            });

            $(".town").select2({
                placeholder: "İlçe",
                allowClear: true
            });

            $("#city").on("change", function (e) {
                var city_id = $(e.target).val();
                get_towns(city_id)
            })

            function get_towns(city_id) {
                $('.town').append(null).trigger('change');
                $(".town option").remove();
                if (!city_id) return
                $.ajax({
                    type: "POST",
                    url: "/Customer/Town?id=" + city_id,
                    beforeSend: function () {
                        OnAdding();
                    },
                    success: function (r) {
                        OnAddComplate();
                        if (r) {
                            $('.town').append(null).trigger('change');
                            r.forEach(s => {
                                $(".town").append("<option value='" + s.id + "'>" + s.town_name + "</option>");
                            })
                        }

                    }
                });
            }

        </script>
    }
